@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix ex: <http://example.com/ex#> .
@prefix Person: <http://example.com/ns/Person#> .
@prefix Class: <http://example.com/ns/Class#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix dash: <http://datashapes.org/dash#> .

#####################################################
# Person Transformation Shape
#####################################################

ex:PersonTransformationShape
    a sh:NodeShape ;
    sh:codeIdentifier "PersonTransformationShape" ;
    sh:name "Person Transformation Shape" ;
    sh:description """Transforms source Person data (ex: namespace) to target Person data (Person:/Class: namespaces).
        Handles namespace migration, derives fullName from firstName and lastName, 
        and calculates age from birthDate.""" ;
    sh:targetClass ex:Person ;
    sh:severity sh:Violation ;
    
    # Rule 1: Transform the subject URI
    sh:rule [
        a sh:SPARQLRule ;
        sh:codeIdentifier "TransformPersonURI" ;
        sh:name "Transform Person URI" ;
        sh:description "Transforms ex:JaneDoe to Person:JaneDoe" ;
        sh:construct """
            PREFIX ex: <http://example.com/ex#>
            PREFIX Person: <http://example.com/ns/Person#>
            PREFIX Class: <http://example.com/ns/Class#>
            
            CONSTRUCT {
                ?targetSubject a Class:Person .
            }
            WHERE {
                $this a ex:Person .
                BIND(IRI(REPLACE(STR($this), "http://example.com/ex#", "http://example.com/ns/Person#")) AS ?targetSubject)
            }
        """ ;
    ] ;
    
    # Rule 2: Copy firstName property
    sh:rule [
        a sh:SPARQLRule ;
        sh:codeIdentifier "CopyFirstName" ;
        sh:name "Copy First Name" ;
        sh:description "Copies ex:firstName to target namespace" ;
        sh:construct """
            PREFIX ex: <http://example.com/ex#>
            PREFIX Person: <http://example.com/ns/Person#>
            
            CONSTRUCT {
                ?targetSubject ex:firstName ?firstName .
            }
            WHERE {
                $this ex:firstName ?firstName .
                BIND(IRI(REPLACE(STR($this), "http://example.com/ex#", "http://example.com/ns/Person#")) AS ?targetSubject)
            }
        """ ;
    ] ;
    
    # Rule 3: Copy lastName property
    sh:rule [
        a sh:SPARQLRule ;
        sh:codeIdentifier "CopyLastName" ;
        sh:name "Copy Last Name" ;
        sh:description "Copies ex:lastName to target namespace" ;
        sh:construct """
            PREFIX ex: <http://example.com/ex#>
            PREFIX Person: <http://example.com/ns/Person#>
            
            CONSTRUCT {
                ?targetSubject ex:lastName ?lastName .
            }
            WHERE {
                $this ex:lastName ?lastName .
                BIND(IRI(REPLACE(STR($this), "http://example.com/ex#", "http://example.com/ns/Person#")) AS ?targetSubject)
            }
        """ ;
    ] ;
    
    # Rule 4: Generate fullName from firstName + lastName using node expression
    sh:rule [
        a sh:SPARQLRule ;
        sh:codeIdentifier "GenerateFullName" ;
        sh:name "Generate Full Name" ;
        sh:description "Derives Person:fullName by concatenating firstName and lastName with a space" ;
        sh:construct """
            PREFIX ex: <http://example.com/ex#>
            PREFIX Person: <http://example.com/ns/Person#>
            
            CONSTRUCT {
                ?targetSubject Person:fullName ?fullName .
            }
            WHERE {
                $this ex:firstName ?firstName ;
                      ex:lastName ?lastName .
                BIND(CONCAT(?firstName, " ", ?lastName) AS ?fullName)
                BIND(IRI(REPLACE(STR($this), "http://example.com/ex#", "http://example.com/ns/Person#")) AS ?targetSubject)
            }
        """ ;
    ] ;
    
    # Rule 5: Calculate age from birthDate using node expression
    sh:rule [
        a sh:SPARQLRule ;
        sh:codeIdentifier "CalculateAge" ;
        sh:name "Calculate Age" ;
        sh:description "Calculates Person:age from ex:birthDate based on current date (2026-01-10)" ;
        sh:construct """
            PREFIX ex: <http://example.com/ex#>
            PREFIX Person: <http://example.com/ns/Person#>
            PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
            
            CONSTRUCT {
                ?targetSubject Person:age ?age .
            }
            WHERE {
                $this ex:birthDate ?birthDate .
                BIND(IRI(REPLACE(STR($this), "http://example.com/ex#", "http://example.com/ns/Person#")) AS ?targetSubject)
                # Calculate age: current year - birth year
                BIND(YEAR("2026-01-10"^^xsd:date) - YEAR(?birthDate) AS ?yearDiff)
                # Adjust if birthday hasn't occurred this year
                BIND(IF(
                    (MONTH("2026-01-10"^^xsd:date) < MONTH(?birthDate)) ||
                    (MONTH("2026-01-10"^^xsd:date) = MONTH(?birthDate) && DAY("2026-01-10"^^xsd:date) < DAY(?birthDate)),
                    ?yearDiff - 1,
                    ?yearDiff
                ) AS ?age)
            }
        """ ;
    ] ;
    
    # Property shape for firstName validation
    sh:property [
        sh:path ex:firstName ;
        sh:codeIdentifier "firstNameProperty" ;
        sh:name "First Name Property" ;
        sh:description "Validates that firstName exists and is a non-empty string" ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
        sh:severity sh:Violation ;
    ] ;
    
    # Property shape for lastName validation
    sh:property [
        sh:path ex:lastName ;
        sh:codeIdentifier "lastNameProperty" ;
        sh:name "Last Name Property" ;
        sh:description "Validates that lastName exists and is a non-empty string" ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
        sh:severity sh:Violation ;
    ] ;
    
    # Property shape for birthDate validation
    sh:property [
        sh:path ex:birthDate ;
        sh:codeIdentifier "birthDateProperty" ;
        sh:name "Birth Date Property" ;
        sh:description "Validates that birthDate exists, is a valid date, and is in the past" ;
        sh:datatype xsd:date ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:maxInclusive "2026-01-10"^^xsd:date ;
        sh:severity sh:Violation ;
    ] ;
    .

#####################################################
# Target Person Validation Shape
#####################################################

ex:TargetPersonShape
    a sh:NodeShape ;
    sh:codeIdentifier "TargetPersonShape" ;
    sh:name "Target Person Validation Shape" ;
    sh:description """Validates the transformed Person data in the target namespace (Person:/Class:).
        Ensures all required properties exist with correct datatypes and constraints.""" ;
    sh:targetClass Class:Person ;
    sh:severity sh:Violation ;
    
    # Validate firstName in target
    sh:property [
        sh:path ex:firstName ;
        sh:codeIdentifier "targetFirstNameProperty" ;
        sh:name "Target First Name" ;
        sh:description "Validates firstName in transformed data" ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
    ] ;
    
    # Validate lastName in target
    sh:property [
        sh:path ex:lastName ;
        sh:codeIdentifier "targetLastNameProperty" ;
        sh:name "Target Last Name" ;
        sh:description "Validates lastName in transformed data" ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 1 ;
    ] ;
    
    # Validate fullName in target
    sh:property [
        sh:path Person:fullName ;
        sh:codeIdentifier "fullNameProperty" ;
        sh:name "Full Name Property" ;
        sh:description "Validates that fullName exists and matches the pattern 'FirstName LastName'" ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minLength 3 ;
        sh:pattern "^[A-Za-z]+ [A-Za-z]+$" ;
        sh:message "Full name must be in format 'FirstName LastName'" ;
    ] ;
    
    # Validate age in target
    sh:property [
        sh:path Person:age ;
        sh:codeIdentifier "ageProperty" ;
        sh:name "Age Property" ;
        sh:description "Validates that age is a non-negative integer less than 150" ;
        sh:datatype xsd:integer ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:minInclusive 0 ;
        sh:maxInclusive 150 ;
    ] ;
    .

#####################################################
# Node Expression Functions (SHACL 1.2)
#####################################################

ex:FullNameExpression
    a sh:NodeExpression ;
    sh:codeIdentifier "fullNameExpression" ;
    sh:name "Full Name Expression" ;
    sh:description "Node expression that concatenates firstName and lastName to create fullName" ;
    sh:select """
        PREFIX ex: <http://example.com/ex#>
        SELECT ?fullName
        WHERE {
            $this ex:firstName ?firstName ;
                  ex:lastName ?lastName .
            BIND(CONCAT(?firstName, " ", ?lastName) AS ?fullName)
        }
    """ ;
    .

ex:AgeCalculationExpression
    a sh:NodeExpression ;
    sh:codeIdentifier "ageCalculationExpression" ;
    sh:name "Age Calculation Expression" ;
    sh:description "Node expression that calculates age from birthDate relative to 2026-01-10" ;
    sh:select """
        PREFIX ex: <http://example.com/ex#>
        PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
        SELECT ?age
        WHERE {
            $this ex:birthDate ?birthDate .
            BIND(YEAR("2026-01-10"^^xsd:date) - YEAR(?birthDate) AS ?yearDiff)
            BIND(IF(
                (MONTH("2026-01-10"^^xsd:date) < MONTH(?birthDate)) ||
                (MONTH("2026-01-10"^^xsd:date) = MONTH(?birthDate) && DAY("2026-01-10"^^xsd:date) < DAY(?birthDate)),
                ?yearDiff - 1,
                ?yearDiff
            ) AS ?age)
        }
    """ ;
    .

ex:NamespaceTransformExpression
    a sh:NodeExpression ;
    sh:codeIdentifier "namespaceTransformExpression" ;
    sh:name "Namespace Transform Expression" ;
    sh:description "Node expression that transforms ex: namespace URIs to Person: namespace" ;
    sh:select """
        PREFIX ex: <http://example.com/ex#>
        PREFIX Person: <http://example.com/ns/Person#>
        SELECT ?targetURI
        WHERE {
            BIND(IRI(REPLACE(STR($this), "http://example.com/ex#", "http://example.com/ns/Person#")) AS ?targetURI)
        }
    """ ;
    .

#####################################################
# Property Path Expressions for Derived Values
#####################################################

ex:FullNamePath
    a sh:PropertyShape ;
    sh:codeIdentifier "derivedFullNamePath" ;
    sh:name "Derived Full Name Path" ;
    sh:description "Property path that derives fullName using node expression" ;
    sh:path Person:fullName ;
    sh:values ex:FullNameExpression ;
    sh:severity sh:Info ;
    .

ex:AgePath
    a sh:PropertyShape ;
    sh:codeIdentifier "derivedAgePath" ;
    sh:name "Derived Age Path" ;
    sh:description "Property path that calculates age using node expression" ;
    sh:path Person:age ;
    sh:values ex:AgeCalculationExpression ;
    sh:severity sh:Info ;
    .

#####################################################
# Constraint Components
#####################################################

ex:NameConsistencyConstraint
    a sh:ConstraintComponent ;
    sh:codeIdentifier "nameConsistencyConstraint" ;
    sh:name "Name Consistency Constraint" ;
    sh:description "Validates that fullName matches the concatenation of firstName and lastName" ;
    sh:parameter [
        sh:path ex:checkFullName ;
        sh:datatype xsd:boolean ;
    ] ;
    sh:validator [
        a sh:SPARQLSelectValidator ;
        sh:message "Full name must equal 'firstName lastName'" ;
        sh:select """
            PREFIX ex: <http://example.com/ex#>
            PREFIX Person: <http://example.com/ns/Person#>
            SELECT $this ?value
            WHERE {
                $this ex:firstName ?firstName ;
                      ex:lastName ?lastName ;
                      Person:fullName ?fullName .
                BIND(CONCAT(?firstName, " ", ?lastName) AS ?expected)
                FILTER(?fullName != ?expected)
                BIND(?fullName AS ?value)
            }
        """ ;
    ] ;
    .

#####################################################
# Metadata and Annotations
#####################################################

ex:PersonTransformationShape
    rdfs:comment "Primary transformation shape for converting ex:Person instances to Class:Person instances" ;
    rdfs:seeAlso <https://www.w3.org/TR/shacl12-core/> ;
    sh:order 1 ;
    .

ex:TargetPersonShape
    rdfs:comment "Validation shape for transformed Person data" ;
    rdfs:seeAlso <https://www.w3.org/TR/shacl12-core/> ;
    sh:order 2 ;
    .
